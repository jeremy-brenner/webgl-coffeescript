// Generated by CoffeeScript 1.6.2
(function() {
  var webGLLesson,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  webGLLesson = (function() {
    function webGLLesson(canvas_id) {
      this.tick = __bind(this.tick, this);      this.canvas = document.getElementById(canvas_id);
      this.textureLocation = "img/lament_configuration.jpg";
      this.initGL();
      this.createMatrices();
      this.initShaders();
      this.initBuffers();
      this.initTexture();
      this.gl.clearColor(0.0, 0.0, 0.0, 1.0);
      this.gl.enable(this.gl.DEPTH_TEST);
      this.xRot = 0;
      this.yRot = 0;
      this.zRot = 0;
      this.mvMatrixStack = [];
      this.running = true;
      this.ready = false;
      this.tick();
    }

    webGLLesson.prototype.stop = function() {
      return this.running = false;
    };

    webGLLesson.prototype.tick = function() {
      if (this.running) {
        requestAnimFrame(this.tick);
        if (this.ready) {
          this.drawScene();
          return this.animate();
        }
      }
    };

    webGLLesson.prototype.shaderFs = "precision mediump float;\n\nvarying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\n\nvoid main(void) {\n  gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}";

    webGLLesson.prototype.shaderVs = "attribute vec3 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\n\nvarying vec2 vTextureCoord;\n\nvoid main(void) {\n  gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);\n  vTextureCoord = aTextureCoord;\n}";

    webGLLesson.prototype.initGL = function() {
      this.gl = this.canvas.getContext("experimental-webgl");
      this.gl.viewportWidth = this.canvas.width;
      return this.gl.viewportHeight = this.canvas.height;
    };

    webGLLesson.prototype.createMatrices = function() {
      this.mvMatrix = mat4.create();
      return this.pMatrix = mat4.create();
    };

    webGLLesson.prototype.initShaders = function() {
      this.fragmentShader = this.getShader(this.gl.FRAGMENT_SHADER, this.shaderFs);
      this.vertexShader = this.getShader(this.gl.VERTEX_SHADER, this.shaderVs);
      this.shaderProgram = this.gl.createProgram();
      this.gl.attachShader(this.shaderProgram, this.vertexShader);
      this.gl.attachShader(this.shaderProgram, this.fragmentShader);
      this.gl.linkProgram(this.shaderProgram);
      if (!this.gl.getProgramParameter(this.shaderProgram, this.gl.LINK_STATUS)) {
        alert("Could not initialise shaders");
      }
      this.gl.useProgram(this.shaderProgram);
      this.shaderProgram.vertexPositionAttribute = this.gl.getAttribLocation(this.shaderProgram, "aVertexPosition");
      this.gl.enableVertexAttribArray(this.shaderProgram.vertexPositionAttribute);
      this.shaderProgram.textureCoordAttribute = this.gl.getAttribLocation(this.shaderProgram, "aTextureCoord");
      this.gl.enableVertexAttribArray(this.shaderProgram.textureCoordAttribute);
      this.shaderProgram.pMatrixUniform = this.gl.getUniformLocation(this.shaderProgram, "uPMatrix");
      this.shaderProgram.mvMatrixUniform = this.gl.getUniformLocation(this.shaderProgram, "uMVMatrix");
      return this.shaderProgram.samplerUniform = this.gl.getUniformLocation(this.shaderProgram, "uSampler");
    };

    webGLLesson.prototype.getShader = function(type, code) {
      var shader;

      shader = this.gl.createShader(type);
      this.gl.shaderSource(shader, code);
      this.gl.compileShader(shader);
      if (!this.gl.getShaderParameter(shader, this.gl.COMPILE_STATUS)) {
        alert(this.gl.getShaderInfoLog(shader));
        return null;
      }
      return shader;
    };

    webGLLesson.prototype.setMatrixUniforms = function() {
      this.gl.uniformMatrix4fv(this.shaderProgram.pMatrixUniform, false, this.pMatrix);
      return this.gl.uniformMatrix4fv(this.shaderProgram.mvMatrixUniform, false, this.mvMatrix);
    };

    webGLLesson.prototype.initBuffers = function() {
      var cubeVertexIndices, vertices;

      this.cubeVertexPositionBuffer = this.gl.createBuffer();
      this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.cubeVertexPositionBuffer);
      vertices = [-1.0, -1.0, 1.0, 1.0, -1.0, 1.0, 1.0, 1.0, 1.0, -1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, -1.0, 1.0, 1.0, -1.0, 1.0, -1.0, -1.0, -1.0, 1.0, -1.0, -1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, 1.0, -1.0, -1.0, 1.0, -1.0, 1.0, -1.0, -1.0, 1.0, 1.0, -1.0, -1.0, 1.0, 1.0, -1.0, 1.0, 1.0, 1.0, 1.0, -1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, 1.0, -1.0, 1.0, 1.0, -1.0, 1.0, -1.0];
      this.gl.bufferData(this.gl.ARRAY_BUFFER, new Float32Array(vertices), this.gl.STATIC_DRAW);
      this.cubeVertexPositionBuffer.itemSize = 3;
      this.cubeVertexPositionBuffer.numItems = 24;
      this.cubeVertexTextureCoordBuffer = this.gl.createBuffer();
      this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.cubeVertexTextureCoordBuffer);
      this.textureCoords = [0.012, 0.04, 0.32, 0.04, 0.32, 0.345, 0.012, 0.345, 0.344, 0.36, 0.656, 0.36, 0.656, 0.668, 0.344, 0.668, 0.348, 0.686, 0.656, 0.686, 0.656, 0.994, 0.348, 0.994, 0.012, 0.36, 0.32, 0.36, 0.32, 0.668, 0.012, 0.668, 0.014, 0.686, 0.318, 0.686, 0.318, 0.994, 0.014, 0.994, 0.345, 0.037, 0.654, 0.037, 0.654, 0.341, 0.345, 0.341];
      this.gl.bufferData(this.gl.ARRAY_BUFFER, new Float32Array(this.textureCoords), this.gl.STATIC_DRAW);
      this.cubeVertexTextureCoordBuffer.itemSize = 2;
      this.cubeVertexTextureCoordBuffer.numItems = 24;
      this.cubeVertexIndexBuffer = this.gl.createBuffer();
      this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER, this.cubeVertexIndexBuffer);
      cubeVertexIndices = [0, 1, 2, 0, 2, 3, 4, 5, 6, 4, 6, 7, 8, 9, 10, 8, 10, 11, 12, 13, 14, 12, 14, 15, 16, 17, 18, 16, 18, 19, 20, 21, 22, 20, 22, 23];
      this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(cubeVertexIndices), this.gl.STATIC_DRAW);
      this.cubeVertexIndexBuffer.itemSize = 1;
      return this.cubeVertexIndexBuffer.numItems = 36;
    };

    webGLLesson.prototype.drawScene = function() {
      var cubeVector;

      this.gl.viewport(0, 0, this.gl.viewportWidth, this.gl.viewportHeight);
      this.gl.clear(this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT);
      mat4.perspective(this.pMatrix, 45, this.gl.viewportWidth / this.gl.viewportHeight, 0.1, 100.0);
      mat4.identity(this.mvMatrix);
      cubeVector = vec3.create();
      vec3.set(cubeVector, 0.0, 0.0, -3.5);
      mat4.translate(this.mvMatrix, this.mvMatrix, cubeVector);
      mat4.rotate(this.mvMatrix, this.mvMatrix, degToRad(this.xRot), [1, 0, 0]);
      mat4.rotate(this.mvMatrix, this.mvMatrix, degToRad(this.yRot), [0, 1, 0]);
      mat4.rotate(this.mvMatrix, this.mvMatrix, degToRad(this.zRot), [0, 0, 1]);
      this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.cubeVertexPositionBuffer);
      this.gl.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute, this.cubeVertexPositionBuffer.itemSize, this.gl.FLOAT, false, 0, 0);
      this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.cubeVertexTextureCoordBuffer);
      this.gl.vertexAttribPointer(this.shaderProgram.textureCoordAttribute, this.cubeVertexTextureCoordBuffer.itemSize, this.gl.FLOAT, false, 0, 0);
      this.gl.activeTexture(this.gl.TEXTURE0);
      this.gl.bindTexture(this.gl.TEXTURE_2D, this.cubeTexture);
      this.gl.uniform1i(this.shaderProgram.samplerUniform, 0);
      this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER, this.cubeVertexIndexBuffer);
      this.setMatrixUniforms();
      return this.gl.drawElements(this.gl.TRIANGLES, this.cubeVertexIndexBuffer.numItems, this.gl.UNSIGNED_SHORT, 0);
    };

    webGLLesson.prototype.initTexture = function() {
      var _this = this;

      this.cubeTexture = this.gl.createTexture();
      this.cubeTexture.image = new Image();
      this.cubeTexture.image.onload = function() {
        return _this.handleLoadedTexture();
      };
      return this.cubeTexture.image.src = this.textureLocation;
    };

    webGLLesson.prototype.handleLoadedTexture = function() {
      this.gl.bindTexture(this.gl.TEXTURE_2D, this.cubeTexture);
      this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL, true);
      this.gl.texImage2D(this.gl.TEXTURE_2D, 0, this.gl.RGBA, this.gl.RGBA, this.gl.UNSIGNED_BYTE, this.cubeTexture.image);
      this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MAG_FILTER, this.gl.LINEAR);
      this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_MIN_FILTER, this.gl.LINEAR_MIPMAP_NEAREST);
      this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_S, this.gl.CLAMP_TO_EDGE);
      this.gl.texParameteri(this.gl.TEXTURE_2D, this.gl.TEXTURE_WRAP_T, this.gl.CLAMP_TO_EDGE);
      this.gl.generateMipmap(this.gl.TEXTURE_2D);
      this.gl.bindTexture(this.gl.TEXTURE_2D, null);
      return this.ready = true;
    };

    webGLLesson.prototype.animate = function() {
      var elapsed, timeNow;

      timeNow = new Date().getTime();
      if (this.lastTime) {
        elapsed = timeNow - this.lastTime;
        this.xRot += (15 * elapsed) / 1000.0;
        this.yRot += (10 * elapsed) / 1000.0;
        this.zRot += (20 * elapsed) / 1000.0;
      }
      return this.lastTime = timeNow;
    };

    webGLLesson.prototype.mvPushMatrix = function() {
      var copy;

      copy = mat4.create();
      mat4.copy(copy, this.mvMatrix);
      return this.mvMatrixStack.push(copy);
    };

    webGLLesson.prototype.mvPopMatrix = function() {
      if (this.mvMatrixStack.length === 0) {
        throw "Invalid popMatrix!";
      }
      return this.mvMatrix = this.mvMatrixStack.pop();
    };

    return webGLLesson;

  })();

  jQuery(function() {
    return web_gl_lessons.add("Lesson05", webGLLesson);
  });

}).call(this);
